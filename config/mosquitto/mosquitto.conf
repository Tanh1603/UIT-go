# Mosquitto MQTT Broker Configuration
# Minimal configuration for driver location updates

# ⚠️ CRITICAL FIX FOR DOCKER ⚠️
# This tells Mosquitto to accept connections on ALL IP addresses (0.0.0.0)
# Without this, it only listens on localhost inside the container.
# Listen on default MQTT port (TCP)
listener 1883 0.0.0.0
protocol mqtt

# Listen on WebSocket port (for web clients if needed)
listener 9001
protocol websockets

# ⚠️ CRITICAL FOR K6 ⚠️
# K6 xk6-mqtt often connects without user/pass for testing.
# Mosquitto 2.0+ blocks this by default.
# Allow anonymous connections (no authentication for testing)
allow_anonymous true

# Persistence (save messages to disk for reliability)
persistence true
persistence_location /mosquitto/data/

# Logging
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
# ❌ DISABLED: Verbose logging causes I/O overhead and DNS lookups
# log_type notice
# log_type information
# log_type subscribe
# log_type unsubscribe
# log_type websockets
# log_type all

# Maximum queued messages per client
max_queued_messages 1000

# Connection settings
max_connections -1

# ⚡ CRITICAL PERFORMANCE FIX: Disable reverse DNS lookups
# Docker DNS is slow - reverse lookups block connection thread
# This causes linear delays when K6 connects multiple VUs
connection_messages false

# Disable per-client logging (reduces I/O overhead)
per_listener_settings false

# Message size limit (10MB)
message_size_limit 10485760
